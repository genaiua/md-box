<!doctype html>
<html lang="uk">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat iFrame</title>

<!-- Markdown + санітизація -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root { --bubble-w: 640px; --pad: 12px; }
  html,body{height:100%}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:transparent}
  .wrap{padding:10px}
  .msg{max-width:var(--bubble-w); margin:8px 0; padding:10px 12px; border-radius:12px}
  .user{margin-left:auto; background:#f0f2f5; box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .bot{margin-right:auto; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.08)}
  .md-compact{font-size:13.5px; line-height:1.56; letter-spacing:.003em; word-break:break-word}
  .md-compact p{margin:.28em 0}
  .md-compact ul{margin:.18em 0; padding-left:1.1em; list-style-position:outside}
  .md-compact ol{margin:.18em 0; padding-left:1.45em; list-style-position:outside}
  .md-compact li{margin:.08em 0}
  .md-compact code{padding:0 .2em; border-radius:.2em; background:#f5f6f7}
  .md-compact pre{margin:.25em 0; padding:.5em; border-radius:.5em; background:#f5f6f7; overflow:auto}
  .md-compact h1{margin:.4em 0 .2em; font-size:1.06em; font-weight:600}
  .md-compact h2{margin:.35em 0 .15em; font-size:1.04em; font-weight:600}
  .md-compact h3{margin:.3em 0 .1ем; font-size:1.02em; font-weight:600}
  .cursor{display:inline-block; width:.6ch; line-height:1; vertical-align:baseline}
</style>

<div id="chat" class="wrap" aria-live="polite"></div>

<script>
  // ---- MD → safe HTML (такий самий whitelist, як у Wix) ----
  const ALLOWED_TAGS = [
    'p','blockquote','ul','ol','li','b','i','strong','em','s',
    'code','pre','a','br','hr','h1','h2','h3','h4','h5','h6'
  ];
  const ALLOWED_ATTR = ['href','target','rel','class'];
  marked.setOptions({ gfm:true, breaks:true, smartypants:true, headerIds:false, mangle:false });

  const chat = document.getElementById('chat');

  function mdToHtml(md){
    const raw = marked.parse(md ?? '');
    return DOMPurify.sanitize(raw, { ALLOWED_TAGS, ALLOWED_ATTR });
  }

  function bubble({from, md, html}) {
    const div = document.createElement('div');
    div.className = `msg ${from === 'user' ? 'user' : 'bot'}`;
    if (html) {
      div.innerHTML = `<div class="md-compact">${html}</div>`;
    } else {
      div.innerHTML = `<div class="md-compact">${mdToHtml(md || '')}</div>`;
    }
    return div;
  }

  function renderList(items){
    chat.innerHTML = '';
    (items || []).forEach(it => chat.appendChild(bubble(it)));
    typingEl = null; // скидаємо "друкарську" бульбашку
    scheduleFit();
    scrollToBottom();
  }

  function appendOne(message){
    chat.appendChild(bubble(message || {from:'assistant', md:''}));
    scheduleFit();
    scrollToBottom();
  }

  // --- курсор усередині останнього рядка ---
  function injectCursorAtEnd(html, cursor){
    const liEnd = html.lastIndexOf('</li>');
    if (liEnd !== -1) {
      const lastLiStart = html.lastIndexOf('<li', liEnd);
      const lastPInLiEnd = html.lastIndexOf('</p>', liEnd);
      if (lastPInLiEnd !== -1 && lastPInLiEnd > lastLiStart) {
        return html.slice(0, lastPInLiEnd) + cursor + html.slice(lastPInLiEnd);
      }
      return html.slice(0, liEnd) + cursor + html.slice(liEnd);
    }
    const pEnd = html.lastIndexOf('</p>');
    if (pEnd !== -1) return html.slice(0, pEnd) + cursor + html.slice(pEnd);
    const preEnd = html.lastIndexOf('</pre>');
    if (preEnd !== -1) return html.slice(0, preEnd) + cursor + html.slice(preEnd);
    const divEnd = html.lastIndexOf('</div>');
    if (divEnd !== -1) return html.slice(0, divEnd) + cursor + html.slice(divEnd);
    // коли немає жодного блочного елемента
    return html + cursor;
  }

  // "Друк" із курсором у останній бот-бульбашці
  let typingEl = null;
  function ensureTypingBubble(){
    if (!typingEl) {
      typingEl = bubble({from:'assistant', md:''});
      chat.appendChild(typingEl);
    }
  }
  function renderMdCursor(md, visible){
    ensureTypingBubble();
    const base = mdToHtml(md || '');
    const withCursor = injectCursorAtEnd(base, `<span class="cursor">${visible ? '▍' : ''}</span>`);
    typingEl.querySelector('.md-compact').innerHTML = withCursor;
    scheduleFit();
    scrollToBottom();
  }

  function renderMd(md){
    ensureTypingBubble();
    typingEl.querySelector('.md-compact').innerHTML = mdToHtml(md || '');
    typingEl = null;
    scheduleFit();
    scrollToBottom();
  }

  function scrollToBottom(){ window.scrollTo(0, document.documentElement.scrollHeight); }

  // ---- Height autosize (дроселювання) ----
  let fitPending = false;
  function fitNow(){
    fitPending = false;
    const h = Math.max(
      document.documentElement.scrollHeight,
      document.body.scrollHeight,
      chat.scrollHeight
    );
    parent.postMessage({ type:'height', height: h }, '*');
  }
  function scheduleFit(){
    if (fitPending) return;
    fitPending = true;
    requestAnimationFrame(fitNow);
  }
  new ResizeObserver(scheduleFit).observe(chat);

  // ---- Безпечний парсер повідомлень (об’єкт або JSON-рядок) ----
  function parseMsg(data){
    let msg = data;
    try { if (typeof msg === 'string') msg = JSON.parse(msg); } catch(_){}
    return (msg && typeof msg === 'object') ? msg : null;
  }

  // ---- Слухаємо Wix + ping/pong ----
  window.addEventListener('message', (e) => {
    const msg = parseMsg(e.data);
    if (!msg) return;

    switch (msg.type) {
      case 'ping':
        parent.postMessage({ type:'pong', t: msg.t ?? Date.now() }, '*');
        return;

      case 'replace': renderList(msg.items); return;
      case 'append' : appendOne(msg.message); return;
      case 'renderMdCursor': renderMdCursor(msg.md || '', !!msg.visible); return;
      case 'renderMd': renderMd(msg.md || ''); return;

      // для діагностики:
      case 'echo?':
        parent.postMessage({ type:'echo!', got: msg }, '*');
        return;
    }
  });

  // ---- Сигнали готовності ----
  window.addEventListener('load', () => {
    parent.postMessage({ type:'ready' }, '*');
    scheduleFit();
  });
</script>
</html>
