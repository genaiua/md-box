<!doctype html>
<html lang="uk">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat iFrame</title>

<!-- Markdown + санітизація -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root { --bubble-w: 640px; --pad: 12px; }
  body{margin:0;font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial}
  .wrap{padding:10px}
  .msg{max-width:var(--bubble-w); margin:8px 0; padding:10px 12px; border-radius:12px}
  .user{margin-left:auto; background:#f0f2f5; box-shadow: 0 1px 2px rgba(0,0,0,.06)}
  .bot{margin-right:auto; background:white; box-shadow: 0 1px 2px rgba(0,0,0,.08)}
  .md-compact{font-size:13.5px; line-height:1.56; letter-spacing:.003em; word-break:break-word}
  .md-compact p{margin:.28em 0}
  .md-compact ul{margin:.18em 0; padding-left:1.1em}
  .md-compact ol{margin:.18em 0; padding-left:1.45em}
  .md-compact li{margin:.08em 0}
  .md-compact code{padding:0 .2em; border-radius:.2em; background:#f5f6f7}
  .md-compact pre{margin:.25em 0; padding:.5em; border-radius:.5em; background:#f5f6f7; overflow:auto}
  .cursor{display:inline-block; width:.6ch}
</style>

<div id="chat" class="wrap" aria-live="polite"></div>

<script>
  const chat = document.getElementById('chat');

  function mdToHtml(md){
    const html = marked.parse(md ?? '');
    return DOMPurify.sanitize(html);
  }

  function bubble({from, md, html}) {
    const div = document.createElement('div');
    div.className = `msg ${from === 'user' ? 'user' : 'bot'}`;
    if (html) {
      div.innerHTML = `<div class="md-compact">${html}</div>`;
    } else {
      div.innerHTML = `<div class="md-compact">${mdToHtml(md)}</div>`;
    }
    return div;
  }

  function renderList(items){
    chat.innerHTML = '';
    (items || []).forEach(it => chat.appendChild(bubble(it)));
    fit();
    scrollToBottom();
  }

  function appendOne(message){
    chat.appendChild(bubble(message));
    fit();
    scrollToBottom();
  }

  // "Друк" із курсором у останній бот-бульбашці
  let typingEl = null;
  function renderMdCursor(md, visible){
    if (!typingEl) {
      typingEl = bubble({from:'assistant', md:''});
      chat.appendChild(typingEl);
    }
    typingEl.querySelector('.md-compact').innerHTML =
      mdToHtml(md) + `<span class="cursor">${visible ? '▍' : ''}</span>`;
    fit();
    scrollToBottom();
  }

  function renderMd(md){
    if (!typingEl) {
      typingEl = bubble({from:'assistant', md:''});
      chat.appendChild(typingEl);
    }
    typingEl.querySelector('.md-compact').innerHTML = mdToHtml(md);
    typingEl = null;
    fit();
    scrollToBottom();
  }

  function fit(){
    // повідомляємо Wix про висоту
    const height = Math.max(document.body.scrollHeight, chat.scrollHeight);
    parent.postMessage({ type:'height', height }, '*');
  }

  function scrollToBottom(){ window.scrollTo(0, document.body.scrollHeight); }

  // слухаємо Wix
  window.addEventListener('message', (e) => {
    const msg = e.data || {};
    switch (msg.type) {
      case 'replace': renderList(msg.items); break;
      case 'append' : appendOne(msg.message); break;
      case 'renderMdCursor': renderMdCursor(msg.md || '', !!msg.visible); break;
      case 'renderMd': renderMd(msg.md || ''); break;
    }
  });

  // сигнал "iframe готовий"
  window.addEventListener('load', () => {
    parent.postMessage({ type:'ready' }, '*');
    fit();
  });

  // опційно: просте поле введення прямо в iFrame (якщо треба)
  // parent.postMessage({ type:'user:send', text: '...' }, '*')
</script>
</html>
