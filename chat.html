<!doctype html>
<html lang="uk">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat iFrame</title>

<!-- Markdown + санітизація -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{
    /* налаштовувані змінні */
    --bubble-max: min(720px, calc(100vw - 48px));
    --pad-v: 10px;
    --pad-h: 14px;
    --radius: 14px;
    --gap: 10px;
    --shadow: 0 1px 2px rgba(0,0,0,.06), 0 6px 24px rgba(0,0,0,.06);
    --shadow-strong: 0 1px 2px rgba(0,0,0,.08), 0 10px 34px rgba(0,0,0,.08);
  }

  html,body{height:100%}
  body{
    margin:0;
    font: clamp(14px, 1.7vw, 16px)/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:transparent;
    color:#111;
  }

  /* стрічка чату */
  #chat{
    padding:16px 12px;
  }

  /* бульбашка */
  .msg{
    display:inline-block;               /* ширина від контенту */
    width:fit-content;
    max-width:var(--bubble-max);
    margin: var(--gap) 0;
    padding: var(--pad-v) var(--pad-h);
    border-radius: var(--radius);
    overflow-wrap: anywhere;
    word-break: normal;
    hyphens: auto;
  }

  /* вирівнювання */
  .user{ margin-left:auto; background:#f3f6ff; box-shadow:var(--shadow-strong); }
  .bot { margin-right:auto; background:#fff;   box-shadow:var(--shadow); }

  /* компактна розмітка MD */
  .md-compact{ letter-spacing:.002em; }
  .md-compact p{ margin:.35em 0 }
  .md-compact ul,.md-compact ol{ margin:.25em 0; padding-left:1.2em }
  .md-compact li{ margin:.1em 0 }
  .md-compact code{
    padding:.08em .35em; border-radius:.28em; background:#f4f5f6;
    font-size:.95em;
  }
  .md-compact pre{
    margin:.3em 0; padding:.65em .75em; border-radius:.6em; background:#f4f5f6; overflow:auto
  }
  .md-compact h1{ margin:.45em 0 .2em; font-size:1.08em; font-weight:600 }
  .md-compact h2{ margin:.35em 0 .15em; font-size:1.05em; font-weight:600 }
  .md-compact h3{ margin:.3em 0 .1em;  font-size:1.02em; font-weight:600 }

  /* курсор друку — на базовій лінії тексту */
  .cursor{ display:inline-block; width:.6ch; line-height:1; vertical-align:baseline }
</style>

<div id="chat" aria-live="polite"></div>

<script>
  // ---- MD → safe HTML (той самий whitelist, що й у Wix) ----
  const ALLOWED_TAGS = [
    'p','blockquote','ul','ol','li','b','i','strong','em','s',
    'code','pre','a','br','hr','h1','h2','h3','h4','h5','h6'
  ];
  const ALLOWED_ATTR = ['href','target','rel','class'];
  marked.setOptions({ gfm:true, breaks:true, smartypants:true, headerIds:false, mangle:false });

  const chat = document.getElementById('chat');

  function mdToHtml(md){
    const raw = marked.parse(md ?? '');
    return DOMPurify.sanitize(raw, { ALLOWED_TAGS, ALLOWED_ATTR });
  }

  function bubble({from, md, html}) {
    const div = document.createElement('div');
    div.className = `msg ${from === 'user' ? 'user' : 'bot'}`;
    if (html) {
      div.innerHTML = `<div class="md-compact">${html}</div>`;
    } else {
      div.innerHTML = `<div class="md-compact">${mdToHtml(md || '')}</div>`;
    }
    return div;
  }

  function renderList(items){
    chat.innerHTML = '';
    (items || []).forEach(it => chat.appendChild(bubble(it)));
    typingEl = null; // скинути «друкарську» бульбашку
    scheduleFit();
    scrollToBottom();
  }

  function appendOne(message){
    chat.appendChild(bubble(message || {from:'assistant', md:''}));
    scheduleFit();
    scrollToBottom();
  }

  // --- курсор у кінці останнього рядка ---
  function injectCursorAtEnd(html, cursor){
    const liEnd = html.lastIndexOf('</li>');
    if (liEnd !== -1) {
      const lastLiStart = html.lastIndexOf('<li', liEnd);
      const lastPInLiEnd = html.lastIndexOf('</p>', liEnd);
      if (lastPInLiEnd !== -1 && lastPInLiEnd > lastLiStart) {
        return html.slice(0, lastPInLiEnd) + cursor + html.slice(lastPInLiEnd);
      }
      return html.slice(0, liEnd) + cursor + html.slice(liEnd);
    }
    const pEnd = html.lastIndexOf('</p>');
    if (pEnd !== -1) return html.slice(0, pEnd) + cursor + html.slice(pEnd);
    const preEnd = html.lastIndexOf('</pre>');
    if (preEnd !== -1) return html.slice(0, preEnd) + cursor + html.slice(preEnd);
    const divEnd = html.lastIndexOf('</div>');
    if (divEnd !== -1) return html.slice(0, divEnd) + cursor + html.slice(divEnd);
    return html + cursor;
  }

  // «Друк» у останній бот-бульбашці
  let typingEl = null;
  function ensureTypingBubble(){
    if (!typingEl) {
      typingEl = bubble({from:'assistant', md:''});
      chat.appendChild(typingEl);
    }
  }
  function renderMdCursor(md, visible){
    ensureTypingBubble();
    const base = mdToHtml(md || '');
    const withCursor = injectCursorAtEnd(base, `<span class="cursor">${visible ? '▍' : ''}</span>`);
    typingEl.querySelector('.md-compact').innerHTML = withCursor;
    scheduleFit();
    scrollToBottom();
  }

  function renderMd(md){
    ensureTypingBubble();
    typingEl.querySelector('.md-compact').innerHTML = mdToHtml(md || '');
    typingEl = null;
    scheduleFit();
    scrollToBottom();
  }

  function scrollToBottom(){ window.scrollTo(0, document.documentElement.scrollHeight); }

  // ---- авто-висота (дроселювання) ----
  let fitPending = false;
  function fitNow(){
    fitPending = false;
    const h = Math.max(
      document.documentElement.scrollHeight,
      document.body.scrollHeight,
      chat.scrollHeight
    );
    parent.postMessage({ type:'height', height: h }, '*');
  }
  function scheduleFit(){
    if (fitPending) return;
    fitPending = true;
    requestAnimationFrame(fitNow);
  }
  new ResizeObserver(scheduleFit).observe(chat);

  // ---- парсер повідомлень (об’єкт або JSON-рядок) ----
  function parseMsg(data){
    let msg = data;
    try { if (typeof msg === 'string') msg = JSON.parse(msg); } catch(_){}
    return (msg && typeof msg === 'object') ? msg : null;
  }

  // ---- Wix + ping/pong ----
  window.addEventListener('message', (e) => {
    const msg = parseMsg(e.data);
    if (!msg) return;

    switch (msg.type) {
      case 'ping': parent.postMessage({ type:'pong', t: msg.t ?? Date.now() }, '*'); return;
      case 'replace': renderList(msg.items); return;
      case 'append' : appendOne(msg.message); return;
      case 'renderMdCursor': renderMdCursor(msg.md || '', !!msg.visible); return;
      case 'renderMd': renderMd(msg.md || ''); return;
      case 'echo?': parent.postMessage({ type:'echo!', got: msg }, '*'); return;
    }
  });

  // ---- готовність ----
  window.addEventListener('load', () => {
    parent.postMessage({ type:'ready' }, '*');
    scheduleFit();
  });
</script>
</html>
